<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Forgot Password | CodeX Systems</title>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,400;0,600;0,700;1,700&display=swap');

body {
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(rgba(0, 0, 15, 0.8), rgba(0, 0, 15, 0.8)), url('img/landing/web-banner.png');
  background-size: cover; background-position: center; background-attachment: fixed;
  margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh;
}

.container { width: 100%; max-width: 420px; text-align: center; padding: 20px; animation: fadeIn 1s ease; }
.logo { width: 250px; margin-bottom: 25px; }

.card-box {
  background: #d1d1d1; padding: 40px 30px; border-radius: 30px;
  box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5); display: flex; flex-direction: column; align-items: center; position: relative; min-height: 400px;
}

.back-btn { position: absolute; top: 20px; left: 20px; text-decoration: none; color: #000; font-size: 20px; font-weight: bold; cursor: pointer; }
.card-box h2 { font-size: 22px; font-weight: 700; font-style: italic; margin: 10px 0 20px 0; color: #000; text-transform: uppercase; }

.step { display: none; width: 100%; flex-direction: column; align-items: center; }
.step.active { display: flex; }

.card-box input {
  width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 15px; background: #9e9e9e; color: #000; font-size: 16px; outline: none; box-sizing: border-box; border: none;
}

.otp-group { display: flex; justify-content: space-between; gap: 8px; margin-bottom: 25px; width: 100%; }
.otp-group input { width: 45px; height: 50px; text-align: center; font-size: 20px; font-weight: bold; background: transparent; border: 1.5px solid #333; border-radius: 8px; }

.btn-primary { width: 60%; background: #00004d; color: white; border: none; border-radius: 50px; padding: 12px 0; font-size: 18px; font-weight: 700; font-style: italic; cursor: pointer; }

.message-box { font-size: 13px; font-weight: 600; margin-top: 15px; display: none; text-align: center; }
.error { color: #dc2626; }
.success { color: #059669; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>

<body>
<div class="container">
  <img src="img/logo.png" alt="CodeX Logo" class="logo">
  <div class="card-box">
    
    <div id="step-email" class="step active">
        <a href="login.html" class="back-btn">←</a>
        <h2>Forgot Password?</h2>
        <p>Enter your email address to verify your account.</p>
        <input type="email" id="resetEmail" placeholder="EMAIL ADDRESS">
        <button type="button" id="checkEmailBtn" class="btn-primary">Verify Now</button>
    </div>

    <div id="step-otp" class="step">
        <div class="back-btn" onclick="toggleStep('step-email')">←</div>
        <h2>Verify Email</h2>
        <p>A code was sent to <br><b id="displayEmail"></b></p>
        <div class="otp-group">
            <input type="text" maxlength="1" class="otp-input">
            <input type="text" maxlength="1" class="otp-input">
            <input type="text" maxlength="1" class="otp-input">
            <input type="text" maxlength="1" class="otp-input">
            <input type="text" maxlength="1" class="otp-input">
            <input type="text" maxlength="1" class="otp-input">
        </div>
        <button type="button" id="verifyOtpBtn" class="btn-primary">Verify Now</button>
    </div>

    <div id="step-reset" class="step">
        <div class="back-btn" onclick="toggleStep('step-otp')">←</div>
        <h2>New Password</h2>
        <input type="password" id="newPass" placeholder="NEW PASSWORD">
        <input type="password" id="confirmPass" placeholder="CONFIRM PASSWORD">
        <button type="button" id="finalBtn" class="btn-primary">Reset</button>
    </div>

    <div id="msgBox" class="message-box"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { getAuth, fetchSignInMethodsForEmail } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
  import { getDatabase, ref, update, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCrZdFPMkDikE5M8Q2V5-Moixvt2jPZGPM",
    authDomain: "camar-hr.firebaseapp.com",
    databaseURL: "https://camar-hr-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "camar-hr",
    storageBucket: "camar-hr.firebasestorage.app",
    messagingSenderId: "760270102206",
    appId: "1:760270102206:web:c3acfe8d8615f5647788ef"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  emailjs.init("Q_wGn2PJdDYUbfjdE"); 

  let generatedOTP = "";
  let targetUserKey = ""; 
  const msgBox = document.getElementById('msgBox');
  const emailBtn = document.getElementById('checkEmailBtn');

  window.toggleStep = (stepId) => {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.getElementById(stepId).classList.add('active');
      msgBox.style.display = "none";
  };

  // 1. Email Validation & Code Sending
  emailBtn.addEventListener("click", async () => {
    const email = document.getElementById('resetEmail').value.trim();
    if (!email) return;

    emailBtn.disabled = true;
    emailBtn.textContent = "..."; 
    msgBox.style.display = "none";

    try {
      // First, check Firebase Auth
      const methods = await fetchSignInMethodsForEmail(auth, email);

      if (methods.length > 0) {
        // Second, check Realtime Database folder 'users'
        const usersRef = ref(db, 'users'); 
        const emailQuery = query(usersRef, orderByChild('email'), equalTo(email));
        const snapshot = await get(emailQuery);

        if (snapshot.exists()) {
          // Success: Capture the unique key (e.g., -OA123...)
          targetUserKey = Object.keys(snapshot.val())[0];
          
          generatedOTP = Math.floor(100000 + Math.random() * 900000).toString();
          
          await emailjs.send("service_pvmlfbh", "template_865es9c", { to_email: email, otp_code: generatedOTP });
          
          document.getElementById('displayEmail').innerText = email;
          toggleStep('step-otp');
        } else {
          // If this triggers, your database folder might not be named 'users'
          showTimedMsg("Email authenticated, but record not found in database.", "error");
        }
      } else {
        showTimedMsg("This email is not registered.", "error"); 
      }
    } catch (e) {
      console.error("Auth/DB Error:", e);
      showTimedMsg("Validation error. Check console.", "error");
    } finally {
      emailBtn.disabled = false;
      emailBtn.textContent = "Verify Now";
    }
  });

  // 2. Verify OTP (Matches your previous logic)
  document.getElementById('verifyOtpBtn').addEventListener('click', () => {
      const enteredOTP = Array.from(document.querySelectorAll('.otp-input')).map(i => i.value).join('');
      if (enteredOTP === generatedOTP) {
          toggleStep('step-reset');
      } else {
          showTimedMsg("Invalid code. Please try again.", "error");
      }
  });

  // 3. Update Password using the stored targetUserKey
  document.getElementById('finalBtn').addEventListener('click', async () => {
    const p1 = document.getElementById('newPass').value;
    const p2 = document.getElementById('confirmPass').value;

    if (p1 !== p2) return showTimedMsg("Passwords do not match.", "error");
    if (p1.length < 6) return showTimedMsg("Min 6 characters.", "error");

    try {
      // Updates password field at users/UNIQUE_KEY
      await update(ref(db, `users/${targetUserKey}`), { password: p1 });
      showTimedMsg("Password updated! Redirecting...", "success");
      setTimeout(() => window.location.href = "login.html", 2500);
    } catch (e) {
      showTimedMsg("Update failed. Check Database Rules.", "error");
    }
  });

  function showTimedMsg(txt, type) {
      msgBox.textContent = txt;
      msgBox.className = `message-box ${type}`;
      msgBox.style.display = "block";
      setTimeout(() => { msgBox.style.display = "none"; }, 5000); 
  }

  document.querySelectorAll('.otp-input').forEach((input, i, list) => {
      input.addEventListener('input', () => { if(input.value && i < list.length - 1) list[i+1].focus(); });
  });
</script>
</body>
</html>