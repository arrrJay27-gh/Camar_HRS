<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN DASHBOARD</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        
* { 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box; 
    font-family: "Inter", sans-serif; 
}

body { 
    display: flex; 
    justify-content: center; 
    background: #C8D2E5; 
    height: 100vh; 
    overflow: hidden; 
}

.app-container { 
    width: 1728px; 
    background: #C8D2E5; 
    position: relative; 
    height: 100vh; 
}

.top-header { 
    width: 100%; 
    height: 100px; 
    background: #6078D1; 
    position: fixed; 
    top: 0; 
    left: 0; 
    z-index: 50; 
    display: flex; 
    align-items: center; 
    padding-left: 340px; 
    padding-right: 60px; 
}

.content-header { 
    width: 100%; 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
}

.search-container { 
    width: 650px; 
    height: 50px; 
    background: transparent; 
    border: 3px solid #fff; 
    border-radius: 30px; 
    padding: 0 25px; 
    display: flex; 
    align-items: center; 
}

.search-input { 
    flex-grow: 1; 
    font-size: 24px; 
    font-weight: 700; 
    color: white; 
    background: transparent; 
    border: none; 
    outline: none; 
}
.search-input::placeholder { color: rgba(255,255,255,0.7); }

.header-icons { display: flex; gap: 30px; }
.header-icon { width: 35px; cursor: pointer; transition: 0.2s; }
.header-icon:hover { opacity: 0.7; }

.sidebar { 
    position: fixed; 
    left: 30px; 
    top: 10px; 
    width: 240px;
    height: calc(100vh - 30px); 
    max-height: 970px; 
    background: #0B074A; 
    border-radius: 20px; 
    padding: 30px 0; 
    z-index: 100; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    overflow-y: auto; 
}
.sidebar::-webkit-scrollbar { display: none; }

.logo-container { 
    width: 130px; 
    height: auto; 
    margin-bottom: -10px; 
    margin-top: 10px;
    flex-shrink: 0; 
}
.logo { 
    width: 100%;
    margin-top:-50px;
}

.user-profile { 
    text-align: center; 
    margin-bottom: 20px; 
    width: 100%; 
    flex-shrink: 0; 
}
.profile-avatar { 
    margin-top:30px;
    width: 120px; 
    height: 120px; 
    border-radius: 50%; 
    overflow: hidden; 
    margin: auto; 
    border: 3px solid rgba(255,255,255,0.1); 
}
.profile-avatar img { 
    width: 100%; 
    height: 100%; 
    object-fit: cover; 
}
.user-name { color: #fff; font-weight: 700; font-size: 16px; margin-top: 20px; font-style: italic; }
.user-role { color: #fff; font-weight: 700; font-size: 18px; margin-top: 5px; font-style: italic; text-transform: uppercase; }

.nav-menu { 
    width: 100%; 
    display: flex; 
    flex-direction: column; 
    gap: -5px; 
    padding: 0 15px; 
    flex-grow: 1; 
}

.nav-item { 
    display: flex; 
    align-items: center; 
    gap: 15px; 
    padding: 12px 20px; 
    cursor: pointer; 
    color: white; 
    transition: 0.2s; 
    border-radius: 12px; 
    flex-shrink: 0; 
}
.nav-item:hover { background: rgba(255, 255, 255, 0.1); }
.nav-item.active { 
    background: #1C1789; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
    border: 1px solid rgba(255,255,255,0.1); 
}

.nav-icon { width: 28px; height: 28px; flex-shrink: 0; }
.nav-text { font-size: 18px; font-weight: 700; font-style: italic; }

.logout-container { 
    gap: 50px;
    margin-top: auto; 
    width: 100%; 
    padding: 20px 15px 0 15px; 
    flex-shrink: 0; 
}

.main-content { 
    position: absolute; 
    top: 0; 
    left: 300px; 
    width: calc(100% - 300px); 
    height: 100vh; 
    padding: 40px 60px; 
    padding-top: 140px; 
    overflow-y: auto; 
    padding-bottom: 100px; 
}

.employee-management-section, .applicants-section, .messenger-section { display: none; }
.section-visible { display: block; animation: fadeIn 0.3s ease; }

.section-header { display: flex; align-items: center; gap: 10px; margin-bottom: 30px; }
.section-title { font-size: 28px; font-weight: 700; font-style: italic; }

.cards-row { display: flex; gap: 40px; margin-top: 40px; }
.card { 
    width: 260px; 
    height: 70px; 
    border-radius: 20px; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    color: white; 
    font-size: 28px; 
    font-weight: 700; 
    cursor: pointer; 
    transition: 0.2s; 
}
.card:hover { transform: translateY(-4px); }
.card-dark { background: #070530; }
.card-primary { background: #1C1789; }

.table-container { 
        margin-top: 50px; 
        background: var(--component-bg); 
        border: var(--glass-border); 
        border-radius: 20px; 
        overflow: hidden; 
        display: none; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .table-container.active { display: block; }

    table { width: 100%; border-collapse: collapse; }
    th { 
        padding: 25px; 
        background: rgba(99, 102, 241, 0.1);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05); 
        font-size: 20px; font-weight: 700; 
        color: var(--text-main); 
    }
    td { 
        padding: 18px; 
        font-size: 18px; 
        border-bottom: 1px solid rgba(255, 255, 255, 0.05); 
        color: var(--text-main);
    }
    tr:hover td { background: rgba(255, 255, 255, 0.02); }
    td.status-active { color: var(--success); font-weight: bold; }
    
.applicant-list { display: flex; flex-direction: column; gap: 20px; }

.applicant-card { 
    background: #D9D9D9; 
    border-radius: 20px; 
    padding: 20px 30px; 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    transition: transform 0.2s ease, box-shadow 0.2s ease; 
    cursor: pointer; 
}
.applicant-card:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
    background: #e5e5e5; 
}

.app-left { display: flex; align-items: center; gap: 20px; }
.app-avatar { 
    width: 60px; 
    height: 60px; 
    border-radius: 50%; 
    background: #2dd4bf; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    font-size: 28px; 
    font-weight: 700; 
    color: #000; 
}
.app-info h3 { font-size: 20px; font-weight: 800; margin: 0; font-style: italic; color: #000; }
.app-role { font-size: 14px; font-weight: 700; font-style: italic; color: #000; margin: 2px 0 5px 0; }
.app-msg { 
    font-size: 12px; 
    font-weight: 700; 
    font-style: italic; 
    color: #000; 
    opacity: 0.8; 
    max-width: 400px; 
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis; 
}

.app-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; justify-content: space-between; height: 50px; }
.app-time { font-size: 14px; font-weight: 700; font-style: italic; color: #000; }
.app-dot { width: 10px; height: 10px; border-radius: 50%; }
.dot-blue { background: #0000ff; }

#applicantDetailView { display: none; } 

.detail-card { 
    background: #D9D9D9; 
    border-radius: 30px; 
    padding: 50px; 
    width: 100%; 
    max-width: 1000px; 
    margin-top: 20px; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    text-align: center; 
    position: relative; 
}

.detail-header-content { display: flex; align-items: flex-start; gap: 30px; width: 100%; }
.detail-avatar-large { 
    width: 100px; 
    height: 100px; 
    border-radius: 50%; 
    background: #2dd4bf; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    font-size: 48px; 
    font-weight: 800; 
    color: #000; 
    flex-shrink: 0; 
}
.detail-text-info { text-align: left; flex-grow: 1; }
.detail-name { font-size: 32px; font-weight: 900; font-style: italic; color: #000; margin-bottom: 5px; }
.detail-email { font-size: 16px; font-weight: 700; font-style: italic; color: #444; margin-bottom: 30px; }
.detail-message-box { font-size: 18px; font-weight: 700; font-style: italic; color: #000; line-height: 1.6; margin-bottom: 40px; max-width: 800px; text-align: left; }

.divider-line { width: 100%; height: 2px; background: #000; margin-bottom: 40px; }

.documents-row { display: flex; gap: 60px; justify-content: center; width: 100%; }
.doc-item { display: flex; flex-direction: column; align-items: center; gap: 10px; cursor: pointer; transition: transform 0.2s; }
.doc-item:hover { transform: scale(1.1); }
.doc-icon { font-size: 50px; color: #000; }
.doc-label { font-size: 16px; font-weight: 700; font-style: italic; color: #000; }

.breadcrumb { font-size: 28px; font-weight: 700; font-style: italic; margin-bottom: 20px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
.breadcrumb span { opacity: 0.6; }
.breadcrumb .current { opacity: 1; }

.action-btn { 
    padding: 12px 30px; 
    border: none; 
    border-radius: 10px; 
    font-size: 20px; 
    font-weight: 700; 
    cursor: pointer; 
    transition: all 0.2s; 
    color: white; 
}
.btn-approve { background: #22c55e;  }
.btn-reject { background: #ef4444; }
.action-btn:hover { transform: scale(1.05); opacity: 0.9; }

.messages-container { background: white; border: 3px solid #000; border-radius: 20px; padding: 40px; margin-top: 40px; max-height: 600px; overflow-y: auto; }
.message-item { padding: 25px; border: 2px solid #ddd; border-radius: 15px; margin-bottom: 20px; background: #f9f9f9; }
.message-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
.message-type { background: #6078D1; color: white; padding: 8px 20px; border-radius: 20px; font-size: 14px; font-weight: 700; }
.message-status { padding: 8px 20px; border-radius: 20px; font-size: 14px; font-weight: 700; }
.status-pending { background: #fbbf24; color: #000; }
.status-approved { background: #16a34a; color: white; }
.status-rejected { background: #dc2626; color: white; }
.message-from { font-weight: 700; color: #6078D1; font-size: 16px; }
.message-content { font-size: 16px; line-height: 1.6; color: #333; margin-bottom: 15px; }
.message-actions { display: flex; gap: 10px; margin-top: 15px; }

@keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
       

        @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
    </style>
</head>

<body>

<div class="app-container">
    <div class="top-header">
        <div class="content-header">
            <div class="search-container"><input class="search-input" placeholder="Search....."></div>
           
        </div>
    </div>

    <div class="sidebar">
        <div class="logo-container"><img src="src/assets/logo.png" class="logo" /></div>
        <div class="user-profile">
            <div class="profile-avatar"><img id="hrPhoto" src="src/assets/profile.png"></div>
            <div id="hrName" class="user-name">Loading...</div>
            <div id="hrRole" class="user-role">ADMIN</div>
        </div>

        <div class="nav-menu">
            <div class="nav-item" id="dashboardNav">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
                <span class="nav-text">Dashboard</span>
            </div>
            <div class="nav-item" id="messengerNav">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M2 21L23 12L2 3V10L17 12L2 14V21Z"/></svg>
                <span class="nav-text">Messenger</span>
            </div>
            <div class="nav-item" id="employeeNav">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="8" r="5"/><path d="M20 21C20 16.5817 16.4183 13 12 13C7.58172 13 4 16.5817 4 21"/><rect x="18" y="6" width="4" height="4" rx="1" stroke="white" stroke-width="1.5"/></svg>
                <span class="nav-text">Employee</span>
            </div>
            <div class="nav-item" id="applicantsNav">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="9" cy="7" r="4"/><path d="M3 21C3 17.134 6.13401 14 10 14"/><circle cx="17" cy="7" r="4"/><path d="M14 21C14 17.134 17.134 14 21 14"/></svg>
                <span class="nav-text" id="applicantsCount">Applicants (0)</span>
            </div>
            <div class="nav-item" id="payrollNav">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="3" y="4" width="18" height="16" rx="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                <span class="nav-text">Payroll</span>
            </div>
             <div class="nav-item" id="teamsNav">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                <span class="nav-text">Teams</span>
            </div>
        </div>

        <div class="logout-container">
            <div class="nav-item" id="logoutBtn">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M9 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H9"/><path d="M16 17L21 12L16 7"/><path d="M21 12H9"/></svg>
                <span class="nav-text">Logout</span>
            </div>
        </div>
    </div>

    <div class="main-content">

        <div class="employee-management-section section-visible" id="dashboardSection">
            <div class="section-header">
                <h2 class="section-title">HR Management</h2>
            </div>
            <div class="cards-row">
                <div class="card card-dark" id="attendance-card">Attendance</div>
                <div class="card card-primary" id="leave-card">Leave</div>
                <div class="card card-primary" id="payroll-card">Payroll</div>
                <div class="card card-primary" id="employee-card">Employee</div>
            </div>
            <div class="table-container active" id="attendance-table">
                <table><thead><tr><th>ID</th><th>Name</th><th>Date</th><th>Time In</th><th>Time Out</th><th>Status</th></tr></thead><tbody id="attendanceData"></tbody></table>
            </div>
            <div class="table-container" id="leave-table">
                <table><thead><tr><th>ID</th><th>Name</th><th>Type</th><th>Start</th><th>End</th><th>Status</th></tr></thead><tbody id="leaveData"></tbody></table>
            </div>
            <div class="table-container" id="payroll-table">
                <table><thead><tr><th>ID</th><th>Name</th><th>Period</th><th>Basic</th><th>Net Pay</th></tr></thead><tbody><tr><td>EMP001</td><td>Mark Anthony</td><td>Jan 2024</td><td>$5000</td><td>$4500</td></tr></tbody></table>
            </div>
            <div class="table-container" id="employee-table">
                <table><thead><tr><th>ID</th><th>Name</th><th>Dept</th><th>Position</th><th>Email</th><th>Status</th></tr></thead><tbody id="employeeData"></tbody></table>
            </div>
        </div>

        <div class="messenger-section" id="messengerSection">
            <div class="section-header">
                <h2 class="section-title">Employee Messages</h2>
            </div>
            <div class="messages-container"><div id="hrMessagesList"></div></div>
        </div>

        <div class="applicants-section" id="applicantsSection">
            <div class="section-header">
                <svg width="35" height="35" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="3" style="margin-right:10px;"><path d="M3 21h18M5 21V7l8-4 8 4v14M9 10a2 2 0 1 1-4 0v10h4V10z" /></svg>
                <h2 class="section-title" style="font-style:italic;">Applicants</h2>
            </div>
            <div class="applicant-list" id="applicantsListContainer"></div>
        </div>

        <div id="applicantDetailView">
            <div class="breadcrumb" onclick="closeApplicantDetail()">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="3"><path d="M3 21h18M5 21V7l8-4 8 4v14M9 10a2 2 0 1 1-4 0v10h4V10z" /></svg>
                <span>Applicants > </span> <span class="current" id="detailHeaderName">Name</span>
            </div>

            <div class="detail-card">
                <div class="detail-header-content">
                    <div class="detail-avatar-large" id="detailAvatar">A</div>
                    <div class="detail-text-info">
                        <div class="detail-name" id="detailName">Name</div>
                        <div class="detail-email" id="detailEmail">email@example.com</div>
                    </div>
                </div>

                <div class="detail-message-box">
                    <p id="detailMessage">...</p>
                </div>

                <div class="divider-line"></div>

                <div class="documents-row">
                    <div class="doc-item" onclick="viewDocument(document.getElementById('docResumeLabel').textContent)">
                        <i class="fa-solid fa-file-pdf doc-icon"></i>
                        <span class="doc-label" id="docResumeLabel">Resume.pdf</span>
                    </div>
                    <div class="doc-item" onclick="viewDocument('BirthCertificate.pdf')">
                        <i class="fa-solid fa-file-pdf doc-icon"></i>
                        <span class="doc-label">BirthCertificate.pdf</span>
                    </div>
                    <div class="doc-item" onclick="viewDocument('Degree.pdf')">
                        <i class="fa-solid fa-file-pdf doc-icon"></i>
                        <span class="doc-label">Degree.pdf</span>
                    </div>
                </div>
                
                <div style="margin-top: 40px; display: flex; gap: 20px;">
                    <button class="action-btn btn-approve" id="btnHire" style="font-size: 20px;">Hire</button>
                    <button class="action-btn btn-reject" id="btnDecline" style="font-size: 20px;">Decline</button>
                </div>
            </div>
        </div>

    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getDatabase, ref, onValue, update, push, remove, get, child, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB7-0DHmxBz1ULh4ApnyuVTHAwENv1raSE",
        authDomain: "hr-solution-2da5e.firebaseapp.com",
        projectId: "hr-solution-2da5e",
        storageBucket: "hr-solution-2da5e.appspot.com",
        messagingSenderId: "735828723473",
        appId: "1:735828723473:web:55ccbc99c15575f177eeb0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);

    const hrName = document.getElementById("hrName");
    const hrPhoto = document.getElementById("hrPhoto");

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            let realName = user.email.split('@')[0]; 
            if (user.displayName) realName = user.displayName;
            try {
                const usersRef = ref(database, 'users');
                const q = query(usersRef, orderByChild('email'), equalTo(user.email));
                const snapshot = await get(q);
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const key = Object.keys(data)[0];
                    if (data[key].name) realName = data[key].name; 
                }
            } catch (e) { console.error("Name lookup failed:", e); }
            hrName.textContent = realName;
            hrPhoto.src = user.photoURL || "src/assets/profile.png";
        } else {
            window.location.href = "login.html";
        }
    });

    const logout = () => signOut(auth).then(() => window.location.href = "login.html");
    document.getElementById("logoutBtn").addEventListener("click", logout);
    
    const dashboardNav = document.getElementById("dashboardNav");
    const messengerNav = document.getElementById("messengerNav");
    const employeeNav = document.getElementById("employeeNav");
    const applicantsNav = document.getElementById("applicantsNav");
    const payrollNav = document.getElementById("payrollNav");

    const dashboardSection = document.getElementById("dashboardSection");
    const messengerSection = document.getElementById("messengerSection");
    const applicantsSection = document.getElementById("applicantsSection");
    const applicantDetailView = document.getElementById("applicantDetailView");

    function setActive(element) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
    }

    function hideAll() {
        dashboardSection.classList.remove("section-visible");
        messengerSection.classList.remove("section-visible");
        applicantsSection.classList.remove("section-visible");
        applicantDetailView.style.display = "none"; 
    }

    dashboardNav.addEventListener("click", () => { hideAll(); dashboardSection.classList.add("section-visible"); setActive(dashboardNav); });
    messengerNav.addEventListener("click", () => { hideAll(); messengerSection.classList.add("section-visible"); loadHRMessages(); setActive(messengerNav); });
    employeeNav.addEventListener("click", () => { hideAll(); dashboardSection.classList.add("section-visible"); document.getElementById('employee-card').click(); setActive(employeeNav); });
    applicantsNav.addEventListener("click", () => { hideAll(); applicantsSection.classList.add("section-visible"); setActive(applicantsNav); });
    payrollNav.addEventListener("click", () => { hideAll(); dashboardSection.classList.add("section-visible"); document.getElementById('payroll-card').click(); setActive(payrollNav); });

    // --- DATA LOADING & CACHING ---
    let usersData = {}; 
    onValue(ref(database, 'users'), (snap) => {
        usersData = snap.val() || {};
        updateEmployeeTable(); 
    });

    const applicantsListContainer = document.getElementById("applicantsListContainer");
    const applicantsCount = document.getElementById("applicantsCount");

    onValue(ref(database, 'applicants'), (snapshot) => {
        applicantsListContainer.innerHTML = "";
        const data = snapshot.val();
        
        if (data) {
            applicantsCount.textContent = `Applicants (${Object.keys(data).length})`;
            Object.entries(data).forEach(([key, app]) => {
                const initial = app.name ? app.name.charAt(0).toUpperCase() : "?";
                const colors = ['#2dd4bf', '#22c55e', '#facc15', '#f472b6', '#60a5fa'];
                const color = colors[initial.charCodeAt(0) % colors.length];
                const timeStr = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                const msgPreview = app.message ? app.message : `Hello im ${app.name.split(' ')[0].toLowerCase()} applying for ${app.position.toLowerCase()}...`;

                const card = document.createElement("div");
                card.className = "applicant-card";
                card.onclick = () => openApplicantDetail(key, app, color, initial); 

                card.innerHTML = `
                    <div class="app-left">
                        <div class="app-avatar" style="background:${color}">${initial}</div>
                        <div class="app-info">
                            <h3>${app.name}</h3>
                            <p class="app-role">Applicant</p>
                            <p class="app-msg">${msgPreview}</p>
                        </div>
                    </div>
                    <div class="app-right">
                        <span class="app-time">${timeStr}</span>
                        <div class="app-dot dot-blue"></div>
                    </div>
                `;
                applicantsListContainer.appendChild(card);
            });
        } else {
            applicantsCount.textContent = "Applicants (0)";
            applicantsListContainer.innerHTML = "<p style='text-align:center; font-style:italic;'>No active applicants.</p>";
        }
    });

    window.openApplicantDetail = function(key, appData, color, initial) {
        applicantsSection.classList.remove("section-visible");
        applicantDetailView.style.display = "block";
        applicantDetailView.classList.add("section-visible");

        document.getElementById("detailHeaderName").textContent = appData.name;
        document.getElementById("detailName").textContent = appData.name;
        document.getElementById("detailEmail").textContent = appData.email;
        document.getElementById("detailAvatar").textContent = initial;
        document.getElementById("detailAvatar").style.background = color;
        
        const messageToShow = appData.message 
            ? appData.message 
            : `Hello My name is ${appData.name} applying for ${appData.position}. I'm writing to express my interest in any open position at CodeX. With a strong work ethic, adaptability, and a commitment to making a positive contribution to team goals, I believe I can be a valuable asset to your organization.`;
        
        document.getElementById("detailMessage").textContent = messageToShow;

        if(appData.resumeFile) {
            document.getElementById("docResumeLabel").textContent = appData.resumeFile;
        } else {
            document.getElementById("docResumeLabel").textContent = "Resume.pdf";
        }

        document.getElementById("btnHire").onclick = () => { if(confirm("Hire " + appData.name + "?")) { window.hireApplicant(key); closeApplicantDetail(); } };
        document.getElementById("btnDecline").onclick = () => { if(confirm("Decline " + appData.name + "?")) { window.declineApplicant(key); closeApplicantDetail(); } };
    };

    window.closeApplicantDetail = function() {
        applicantDetailView.style.display = "none";
        applicantsSection.classList.add("section-visible");
    };

    window.viewDocument = function(filename) {
        alert(`Opening document: ${filename}\n\n(Note: File storage not connected in this demo)`);
    };

    window.hireApplicant = async function(key) {
        const snapshot = await get(child(ref(database), `applicants/${key}`));
        if(snapshot.exists()) {
            const data = snapshot.val();
            await push(ref(database, 'users'), {
                name: data.name,
                email: data.email,
                position: data.position,
                department: "Unassigned",
                role: "Employee",
                status: "Active",
                hiredDate: new Date().toISOString()
            });
            await remove(ref(database, `applicants/${key}`));
            alert(`âœ… ${data.name} is now hired!`);
        }
    };

    window.declineApplicant = async function(key) {
        await remove(ref(database, `applicants/${key}`));
        alert("Application declined and removed.");
    };

    const employeeTableBody = document.getElementById("employeeData");
    const attendanceTableBody = document.getElementById("attendanceData");

    function updateEmployeeTable() {
        employeeTableBody.innerHTML = "";
        if(usersData) {
            Object.entries(usersData).forEach(([key, emp]) => {
                const row = document.createElement("tr");
                row.innerHTML = `<td>${key.substring(0,5)}</td><td>${emp.name}</td><td>${emp.department || "-"}</td><td>${emp.position || "-"}</td><td>${emp.email}</td><td style="color:green;font-weight:bold">Active</td>`;
                employeeTableBody.appendChild(row);
            });
        }
    }

    onValue(ref(database, 'attendance'), (snap) => {
        attendanceTableBody.innerHTML = "";
        const data = snap.val();
        if(data) {
            Object.values(data).sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(rec => {
                let matchingUserKey = null;
                let userRole = "Employee"; 
                if (usersData) {
                    const foundEntry = Object.entries(usersData).find(([k, u]) => u.name === rec.name);
                    if (foundEntry) {
                        matchingUserKey = foundEntry[0]; 
                        if (foundEntry[1].role) userRole = foundEntry[1].role;
                    }
                }
                let rolePrefix = "EMP";
                if (rec.name === "maprincess.hr@gmail.com" || rec.name.toLowerCase().includes("admin") || userRole === "HR" || userRole === "Admin") {
                    rolePrefix = "HR";
                }
                let shortId = matchingUserKey ? matchingUserKey.substring(0, 5).toUpperCase() : "000";
                let finalId = `${rolePrefix}-${shortId}`;
                const row = document.createElement("tr");
                row.innerHTML = `<td>${finalId}</td><td>${rec.name}</td><td>${rec.date}</td><td>${rec.timeIn || "-"}</td><td>${rec.timeOut || "-"}</td><td>${rec.status}</td>`;
                attendanceTableBody.appendChild(row);
            });
        }
    });

    function loadHRMessages() {
        const list = document.getElementById("hrMessagesList");
        onValue(ref(database, 'messages'), (snap) => {
            list.innerHTML = "";
            const msgs = snap.val();
            if(!msgs) { list.innerHTML = "<p style='text-align:center'>No messages</p>"; return; }
            Object.entries(msgs).sort((a,b) => new Date(b[1].timestamp) - new Date(a[1].timestamp)).forEach(([key, msg]) => {
                const div = document.createElement("div");
                div.className = "message-item";
                const isPending = msg.status === "Pending";
                div.innerHTML = `
                    <div class="message-header">
                        <span class="message-type">${msg.type}</span>
                        <span class="message-status status-${msg.status.toLowerCase()}">${msg.status}</span>
                    </div>
                    <div class="message-from">From: ${msg.fromName}</div>
                    <div class="message-content">${msg.content}</div>
                    ${isPending ? `<div class="message-actions"><button class="action-btn btn-approve" onclick="window.approveMsg('${key}')">Approve</button><button class="action-btn btn-reject" onclick="window.rejectMsg('${key}')">Reject</button></div>` : ''}
                `;
                list.appendChild(div);
            });
        });
    }

    window.approveMsg = (k) => update(ref(database, `messages/${k}`), {status:"Approved", approvedBy: hrName.textContent});
    window.rejectMsg = (k) => update(ref(database, `messages/${k}`), {status:"Rejected", rejectedBy: hrName.textContent});

    const cards = { 'attendance-card': 'attendance-table', 'leave-card': 'leave-table', 'payroll-card': 'payroll-table', 'employee-card': 'employee-table' };
    Object.keys(cards).forEach(id => {
        document.getElementById(id).addEventListener('click', function() {
            Object.keys(cards).forEach(k => {
                document.getElementById(k).classList.remove('card-dark');
                document.getElementById(k).classList.add('card-primary');
                document.getElementById(cards[k]).classList.remove('active');
            });
            this.classList.remove('card-primary');
            this.classList.add('card-dark');
            document.getElementById(cards[id]).classList.add('active');
        });
    });
</script>
</body>
</html>