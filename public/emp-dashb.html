<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Dashboard</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Inter", sans-serif; }
        body { display: flex; justify-content: center; background: #C8D2E5; min-height: 100vh; }
        .app-container { width: 1728px; background: #C8D2E5; position: relative; }

        /* --- HEADER (Fixed like Admin) --- */
        .top-header { 
            width: 100%; 
            height: 100px; 
            background: #6078D1; /* Original Purple */
            position: fixed; 
            top: 0; 
            left: 0; 
            z-index: 50; 
            display: flex; 
            align-items: center; 
            padding-left: 320px; /* Space for Sidebar */
            padding-right: 60px; 
        }

        .content-header { 
            width: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
        }
        
        .search-container { 
            width: 650px; 
            height: 50px; 
            background: transparent; 
            border: 3px solid #fff; 
            border-radius: 30px; 
            padding: 0 25px; 
            display: flex; 
            align-items: center; 
        }
        
        .search-input { 
            flex-grow: 1; 
            font-size: 24px; 
            font-weight: 700; 
            color: white; 
            background: transparent; 
            border: none; 
            outline: none; 
        }
        .search-input::placeholder { color: rgba(255,255,255,0.7); }
        
        .header-icons { display: flex; gap: 30px; }
        .header-icon { width: 35px; cursor: pointer; transition: 0.2s; }
        .header-icon:hover { opacity: 0.7; }

        /* --- SIDEBAR (Fixed like Admin) --- */
        .sidebar { 
            position: fixed; 
            left: 30px; 
            top: 30px; /* Slight offset top */
            width: 260px; 
            height: calc(100vh - 60px); 
            background: #0B074A; /* Original Dark Blue */
            border-radius: 20px; 
            padding: 40px 20px; 
            z-index: 100; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            overflow-y: auto;
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.5); /* Added Shadow */
        }
        .sidebar::-webkit-scrollbar { display: none; }

        .logo-container { width: 130px; height: auto; margin-bottom: 30px; flex-shrink: 0; }
        .logo { width: 100%; }
        
        .user-profile { text-align: center; margin-bottom: 60px; width: 100%; flex-shrink: 0; }
        .profile-avatar { width: 120px; height: 120px; border-radius: 50%; overflow: hidden; margin: auto; border: 3px solid rgba(255,255,255,0.1); }
        .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-name { color: #fff; font-weight: 700; font-size: 16px; margin-top: 15px; font-style: italic; }
        .user-role { color: #fff; font-weight: 700; font-size: 18px; margin-top: 5px; font-style: italic; text-transform: uppercase; }

        /* --- NAV MENU --- */
        .nav-menu { width: 100%; display: flex; flex-direction: column; gap: 15px; padding: 0 15px; flex-grow: 1; }
        .nav-item { display: flex; align-items: center; gap: 15px; padding: 12px 20px; cursor: pointer; color: white; transition: 0.2s; border-radius: 12px; flex-shrink: 0; }
        .nav-item:hover { background: rgba(255, 255, 255, 0.1); }
        .nav-item.active { background: #1C1789; box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); }
        .nav-icon { width: 28px; height: 28px; flex-shrink: 0; }
        .nav-text { font-size: 18px; font-weight: 700; font-style: italic; }
        .logout-container { margin-top: auto; width: 100%; padding: 20px 15px 0 15px; flex-shrink: 0; }

        /* --- MAIN CONTENT (Scrollable) --- */
        .main-content { 
            position: absolute; 
            top: 0; 
            left: 300px; 
            width: calc(100% - 300px); 
            height: 100vh; 
            padding: 40px 60px; 
            padding-top: 140px; /* Push down for header */
            overflow-y: auto; 
            padding-bottom: 100px; 
        }

        /* SECTIONS */
        .section-view { display: none; }
        .section-view.active { display: block; animation: fadeIn 0.3s ease; }
        .section-header { display: flex; align-items: center; gap: 10px; margin-bottom: 30px; }
        .section-title { font-size: 28px; font-weight: 700; font-style: italic; }

        /* CARDS */
        .cards-row { display: flex; gap: 40px; margin-top: 40px; }
        .card { width: 260px; height: 70px; border-radius: 20px; display: flex; justify-content: center; align-items: center; color: white; font-size: 28px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .card:hover { transform: translateY(-4px); }
        
        .card-dark { background: #070530; }
        .card-primary { background: #1C1789; }

        /* TABLES */
        .table-container { margin-top: 50px; background: white; border: 3px solid #000; overflow: hidden; display: none; }
        .table-container.active { display: block; }
        table { width: 100%; border-collapse: collapse; }
        th { padding: 25px; background: #f3f3f3; border-bottom: 3px solid #000; font-size: 20px; font-weight: 700; }
        td { padding: 18px; font-size: 18px; border-bottom: 1px solid #ddd; }

        /* MESSENGER */
        .message-form { background: white; border: 3px solid #000; border-radius: 20px; padding: 40px; margin-bottom: 40px; }
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; font-size: 18px; font-weight: 700; margin-bottom: 10px; color: #000; }
        .form-group select, .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 14px; font-family: "Inter", sans-serif; outline: none; }
        .submit-btn { background: #6078D1; color: white; border: none; padding: 15px 40px; border-radius: 10px; font-size: 18px; font-weight: 700; cursor: pointer; transition: all 0.3s; }
        .submit-btn:hover { background: #0B074A; transform: translateY(-2px); }

        .my-messages { background: white; border: 3px solid #000; border-radius: 20px; padding: 40px; max-height: 500px; overflow-y: auto; }
        .message-item { padding: 20px; border-bottom: 2px solid #ddd; margin-bottom: 15px; }
        .message-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .message-type { background: #6078D1; color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: 700; }
        .status-badge { padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: 700; }
        .status-Pending { background: #fbbf24; color: #000; }
        .status-Approved { background: #16a34a; color: white; }
        .status-Rejected { background: #dc2626; color: white; }

        /* PROFILE CARD */
        .profile-card {
            background: #fff;
            border-radius: 20px;
            padding: 50px;
            margin-top: 40px;
            display: flex;
            align-items: flex-start; 
            justify-content: space-between;
            max-width: 1000px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .profile-left { display: flex; gap: 40px; align-items: center; }
        .profile-pic-large { width: 180px; height: 180px; border-radius: 50%; background: #d9d9d9; display: flex; align-items: center; justify-content: center; font-size: 64px; font-weight: 800; color: #666; overflow: hidden; }
        .profile-pic-large img { width: 100%; height: 100%; object-fit: cover; }
        
        .profile-details { display: flex; flex-direction: column; gap: 15px; }
        .profile-row { font-size: 20px; color: #000; display: flex; align-items: center; }
        .profile-label { font-weight: 700; width: 130px; text-transform: uppercase; }
        .profile-value { font-weight: 400; }

        .profile-right { display: flex; flex-direction: column; align-items: center; padding-right: 50px; }
        .qr-box { background: #d9d9d9; padding: 15px; width: 180px; height: 180px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; }
        .qr-label { font-size: 14px; font-weight: 700; text-transform: uppercase; color: #000; text-align: center; word-break: break-all; max-width: 200px; }

        @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
    </style>
</head>

<body>

<div class="app-container">
    <div class="top-header">
        <div class="content-header">
            <div class="search-container"><input class="search-input" placeholder="Search....."></div>
            <div class="header-icons">
               
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="logo-container"><img src="src/assets/logo.png" class="logo" alt="Company Logo" /></div>
        <div class="user-profile">
            <div class="profile-avatar"><img id="empPhoto" src="src/assets/profile.png" alt="Employee Profile Picture"></div>
            <div id="empName" class="user-name">Loading...</div>
            <div id="empRole" class="user-role">EMPLOYEE</div>
        </div>

        <div class="nav-menu">
            <div class="nav-item active" onclick="switchSection('dashboard', this)">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
                <span class="nav-text">Dashboard</span>
            </div>
            <div class="nav-item" onclick="switchSection('messenger', this)">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M2 21L23 12L2 3V10L17 12L2 14V21Z"/></svg>
                <span class="nav-text">Messages</span>
            </div>
            <div class="nav-item" onclick="switchSection('profile', this)">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="8" r="5"/><path d="M20 21C20 16.5817 16.4183 13 12 13C7.58172 13 4 16.5817 4 21"/></svg>
                <span class="nav-text">Profile</span>
            </div>
        </div>

        <div class="logout-container">
            <div class="nav-item" id="logoutBtn">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><path d="M16 17L21 12L16 7"/><path d="M21 12H9"/></svg>
                <span class="nav-text">Logout</span>
            </div>
        </div>
    </div>

    <div class="main-content">

        <div id="view-dashboard" class="section-view active">
            <div class="section-header"><h2 class="section-title">My Information</h2></div>
            
            <div class="cards-row">
                <div class="card card-dark" onclick="showTable('attendance')">Attendance</div>
                <div class="card card-primary" onclick="showTable('leave')">Leave</div>
                <div class="card card-primary" onclick="showTable('payroll')">Payroll</div>
            </div>

            <div class="table-container active" id="table-attendance">
                <table><thead><tr><th>Date</th><th>Time In</th><th>Time Out</th><th>Status</th></tr></thead><tbody id="attendanceList"></tbody></table>
            </div>
            <div class="table-container" id="table-leave">
                <table><thead><tr><th>Type</th><th>Start</th><th>End</th><th>Status</th></tr></thead><tbody id="leaveList"></tbody></table>
            </div>
            <div class="table-container" id="table-payroll">
                <table><thead><tr><th>Period</th><th>Basic</th><th>Net Pay</th></tr></thead><tbody><tr><td>Jan 2024</td><td>$5,000</td><td>$4,700</td></tr></tbody></table>
            </div>
        </div>

        <div id="view-messenger" class="section-view">
            <div class="section-header"><h2 class="section-title">Send Message / Request</h2></div>
            <div class="message-form">
                <div class="form-group"><label>Type</label><select id="msgType"><option>Leave Request</option><option>Inquiry</option></select></div>
                <div class="form-group"><label>Subject</label><input type="text" id="msgSubject"></div>
                <div class="form-group"><label>Details</label><textarea id="msgContent"></textarea></div>
                <button class="submit-btn" onclick="sendMessage()">Send</button>
            </div>
            <div class="my-messages">
                <h3>History</h3>
                <div id="messagesList"></div>
            </div>
        </div>

        <div id="view-profile" class="section-view">
            <div class="section-header"><h2 class="section-title">My Profile</h2></div>
            
            <div class="profile-card">
                <div class="profile-left">
                    <div class="profile-pic-large">
                        <img id="profileCardImg" src="src/assets/profile.png" onerror="this.style.display='none'; this.parentElement.textContent='A'">
                    </div>
                    <div class="profile-details">
                        <div class="profile-row"><span class="profile-label">NAME:</span><span class="profile-value" id="pName">Loading...</span></div>
                        <div class="profile-row"><span class="profile-label">EMAIL:</span><span class="profile-value" id="pEmail">Loading...</span></div>
                        <div class="profile-row"><span class="profile-label">POSITION:</span><span class="profile-value" id="pPosition">Employee</span></div>
                        <div class="profile-row"><span class="profile-label">STATUS:</span><span class="profile-value" style="color:green; font-weight:bold;">Active</span></div>
                    </div>
                </div>
                <div class="profile-right">
                    <div class="qr-box" id="qrcode"></div>
                    <div class="qr-label" id="qrLabel">Loading...</div>
                </div>
            </div>
        </div>

    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getDatabase, ref, push, onValue, get, child, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

   const firebaseConfig = {
  apiKey: "AIzaSyCrZdFPMkDikE5M8Q2V5-Moixvt2jPZGPM",
  authDomain: "camar-hr.firebaseapp.com",
  databaseURL: "https://camar-hr-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "camar-hr",
  storageBucket: "camar-hr.firebasestorage.app",
  messagingSenderId: "760270102206",
  appId: "1:760270102206:web:c3acfe8d8615f5647788ef",
  measurementId: "G-25C2JZLZPK"
};


    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    let currentUser = null;

    // --- NAVIGATION ---
    window.switchSection = function(name, el) {
        document.querySelectorAll('.section-view').forEach(s => s.classList.remove('active'));
        document.getElementById('view-' + name).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
    };

    window.showTable = function(name) {
        document.querySelectorAll('.table-container').forEach(t => t.classList.remove('active'));
        document.getElementById('table-' + name).classList.add('active');
        
        document.querySelectorAll('.card').forEach(c => {
            c.classList.remove('card-dark');
            c.classList.add('card-primary');
        });
        
        // Toggle card style
        const cardMap = {'attendance':0, 'leave':1, 'payroll':2};
        if(document.querySelectorAll('.card')[cardMap[name]]) {
            const activeCard = document.querySelectorAll('.card')[cardMap[name]];
            activeCard.classList.remove('card-primary');
            activeCard.classList.add('card-dark');
        }
    };

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            let name = "Employee";
            let empId = user.uid; 
            let position = "Employee";

            try {
                const usersRef = ref(db, 'users');
                const q = query(usersRef, orderByChild('email'), equalTo(user.email));
                const snapshot = await get(q);
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const key = Object.keys(data)[0];
                    name = data[key].name; 
                    if(data[key].position) position = data[key].position;
                }
            } catch (e) {
                console.error("Name lookup failed:", e);
            }

            document.getElementById("empName").textContent = name;
            document.getElementById("pName").textContent = name;
            document.getElementById("pEmail").textContent = user.email;
            document.getElementById("pPosition").textContent = position;
            
            generateQRCode(empId);
            document.getElementById("qrLabel").textContent = empId; 

            loadData(user.uid, user.email);
        } else {
            window.location.href = "login.html";
        }
    });

    function generateQRCode(text) {
        const qrContainer = document.getElementById("qrcode");
        qrContainer.innerHTML = ""; 
        new QRCode(qrContainer, {
            text: text,
            width: 150,
            height: 150,
            colorDark : "#000000",
            colorLight : "#d9d9d9",
            correctLevel : QRCode.CorrectLevel.H
        });
    }

    window.sendMessage = () => {
        const type = document.getElementById("msgType").value;
        const subject = document.getElementById("msgSubject").value;
        const content = document.getElementById("msgContent").value;
        if (!subject || !content) return alert("Fill all fields");

        const realName = document.getElementById("empName").textContent;

        push(ref(db, 'messages'), {
            type, subject, content,
            from: currentUser.email, fromName: realName,
            status: "Pending", timestamp: new Date().toISOString(),
            date: new Date().toLocaleDateString(), time: new Date().toLocaleTimeString()
        }).then(() => {
            alert("Sent!");
            document.getElementById("msgSubject").value = "";
            document.getElementById("msgContent").value = "";
        });
    };

    function loadData(uid, email) {
        onValue(ref(db, 'attendance'), (snap) => {
            const list = document.getElementById("attendanceList");
            list.innerHTML = "";
            const data = snap.val();
            if (data) Object.values(data).filter(l => l.empId === uid).reverse().forEach(log => {
                list.innerHTML += `<tr><td>${log.date}</td><td>${log.timeIn||"-"}</td><td>${log.timeOut||"-"}</td><td>${log.status}</td></tr>`;
            });
        });

        onValue(ref(db, 'messages'), (snap) => {
            const msgList = document.getElementById("messagesList");
            const data = snap.val();
            if (data) {
                Object.values(data).filter(m => m.from === email).sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)).forEach(msg => {
                    msgList.innerHTML += `
                        <div class="message-item">
                            <div class="message-header"><span class="message-type">${msg.type}</span><span class="status-badge status-${msg.status}">${msg.status}</span></div>
                            <strong>${msg.subject}</strong><p class="message-content">${msg.content}</p><div class="message-date">${msg.date}</div>
                        </div>`;
                });
            }
        });
    }

    document.getElementById("logoutBtn").onclick = () => signOut(auth).then(() => window.location.href = "login.html");
</script>

</body>
</html>